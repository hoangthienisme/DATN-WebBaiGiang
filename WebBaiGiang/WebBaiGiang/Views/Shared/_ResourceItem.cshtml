@model WebBaiGiang.Models.TaiNguyen

@{
    var isDrive = Model.Url.Contains("drive.google.com");
    var fileName = System.IO.Path.GetFileName(Model.Url) ?? "File";
}

<div class="card h-100">
    <div class="card-body p-2">
        @if (Model.Loai == "image")
        {
            var imageUrl = GetImageUrl(Model.Url);
            <img src="@imageUrl" alt="@fileName" class="card-img-top mb-2 rounded"
                 style="height: 120px; object-fit: cover;" />
            <a href="@Model.Url" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                <i class="fas fa-image me-1"></i>
                Xem ảnh
            </a>
        }
        else if (Model.Loai == "video")
        {
            var previewUrl = GetVideoPreviewUrl(Model.Url);

            @if (isDrive)
            {
                <div class="ratio ratio-16x9 mb-2">
                    <iframe src="@previewUrl" class="rounded" allowfullscreen></iframe>
                </div>
            }
            else
            {
                <video controls class="w-100 rounded mb-2" style="height: 120px;">
                    <source src="@Model.Url" type="video/mp4" />
                    Trình duyệt không hỗ trợ video.
                </video>
            }

            <a href="@Model.Url" target="_blank" class="btn btn-sm btn-outline-success w-100">
                <i class="fas fa-play me-1"></i>
                Xem video
            </a>
        }
        else if (Model.Loai == "doc" || Model.Loai == "tailieu")
        {
            <div class="text-center py-3">
                <i class="fas fa-file-pdf fa-3x text-danger mb-2"></i>
                <p class="small mb-2">@fileName</p>
            </div>

            <div class="btn-group w-100">
                @if (isDrive)
                {
                    var previewUrl = GetDocumentPreviewUrl(Model.Url);
                    <button type="button" class="btn btn-sm btn-outline-info"
                            data-bs-toggle="modal"
                            data-bs-target="#docModal-@Model.Id">
                        <i class="fas fa-eye"></i>
                    </button>

                    <!-- Modal -->
                    <div class="modal fade" id="docModal-@Model.Id" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">@fileName</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body p-0">
                                    <iframe src="@previewUrl"
                                            style="width: 100%; height: 600px; border: none;"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <a href="@Model.Url" target="_blank" class="btn btn-sm btn-outline-primary flex-fill">
                    <i class="fas fa-download me-1"></i>
                    Tải về
                </a>
            </div>
        }
    </div>
</div>

@{
    string GetImageUrl(string url)
    {
        if (url.Contains("drive.google.com") && url.Contains("/file/d/"))
        {
            var match = System.Text.RegularExpressions.Regex.Match(url, @"/file/d/([a-zA-Z0-9_-]+)");
            if (match.Success)
            {
                var id = match.Groups[1].Value;
                return $"https://drive.google.com/thumbnail?id={id}";
            }
        }
        return url;
    }

    string GetVideoPreviewUrl(string url)
    {
        if (url.Contains("drive.google.com") && url.Contains("view"))
        {
            return url.Replace("view?usp=sharing", "preview");
        }
        return url;
    }

    string GetDocumentPreviewUrl(string url)
    {
        if (url.Contains("drive.google.com") && url.Contains("view"))
        {
            return url.Replace("view?usp=sharing", "preview");
        }
        return url;
    }
}