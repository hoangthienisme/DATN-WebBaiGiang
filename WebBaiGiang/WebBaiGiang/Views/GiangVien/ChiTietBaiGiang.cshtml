@model WebBaiGiang.Models.BaiGiang

@{
    ViewData["Title"] = "Chi tiết bài giảng";
    Layout = "~/Views/Shared/_LayoutGiangvien.cshtml";
    var taiNguyenAnh = Model.TaiNguyens?.Where(t => t.Loai == "image");
    var taiNguyenVideo = Model.TaiNguyens?.Where(t => t.Loai == "video");
    var taiNguyenDocs = Model.TaiNguyens?.Where(t => t.Loai == "tailieu");
}
<link href="~/css/chitietbaigiang.css" rel="stylesheet" />
<div class="container mt-4" style="max-width: 1200px;">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="card-title mb-0">
                        <i class="fas fa-book-open me-2"></i>
                        @Model.Title
                    </h2>
                </div>
                <div class="card-body">
                    <p class="lead text-muted">@Model.Description</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chapters Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-list-ol me-2"></i>
                        Nội dung bài giảng
                    </h4>
                </div>
                <div class="card-body">
                    @if (Model.Chuongs?.Any() == true)
                    {
                        <div class="accordion" id="chaptersAccordion">
                            @foreach (var chuong in Model.Chuongs.OrderBy(c => c.SortOrder))
                            {
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-@chuong.Id">
                                        <button class="accordion-button @(chuong.SortOrder == 1 ? "" : "collapsed")"
                                                type="button" data-bs-toggle="collapse"
                                                data-bs-target="#collapse-@chuong.Id">
                                            <strong>Chương @chuong.SortOrder: @chuong.Title</strong>
                                        </button>
                                    </h2>
                                    <div id="collapse-@chuong.Id"
                                         class="accordion-collapse collapse @(chuong.SortOrder == 1 ? "show" : "")"
                                         data-bs-parent="#chaptersAccordion">
                                        <div class="accordion-body">
                                            @if (chuong.Bais?.Any() == true)
                                            {
                                                @foreach (var bai in chuong.Bais.OrderBy(b => b.SortOrder))
                                                {
                                                    <div class="card mb-3 border-start border-4 border-primary">
                                                        <div class="card-header bg-light">
                                                            <h6 class="mb-0">
                                                                <i class="fas fa-bookmark me-2"></i>
                                                                @bai.SortOrder. @bai.Title
                                                            </h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <p class="text-muted">@bai.Description</p>
                                                            @if (!string.IsNullOrEmpty(bai.VideoUrl))
                                                            {
                                                                var isYouTube = bai.VideoUrl.Contains("youtube.com") || bai.VideoUrl.Contains("youtu.be");
                                                                var embedUrl = bai.VideoUrl;

                                                                if (bai.VideoUrl.Contains("watch?v="))
                                                                {
                                                                    embedUrl = bai.VideoUrl.Replace("watch?v=", "embed/");
                                                                }
                                                                else if (bai.VideoUrl.Contains("youtu.be"))
                                                                {
                                                                    var id = bai.VideoUrl.Split("/").Last();
                                                                    embedUrl = $"https://www.youtube.com/embed/{id}";
                                                                }

                                                                <div class="mt-3">
                                                                    <h6><i class="fas fa-link me-2 text-danger"></i>Video liên kết</h6>
                                                                    <div class="ratio ratio-16x9 mb-2">
                                                                        <iframe src="@embedUrl" allowfullscreen class="rounded border shadow-sm"></iframe>
                                                                    </div>
                                                                </div>
                                                            }

                                                            @if (bai.TaiNguyens?.Any() == true)
                                                            {
                                                                <div class="mt-4">
                                                                    <h6 class="text-primary">
                                                                        <i class="fas fa-folder-open me-2"></i>
                                                                        Tài nguyên bài học (@bai.TaiNguyens.Count() tài nguyên)
                                                                    </h6>
                                                                    <div class="row g-3 mt-2">
                                                                        @foreach (var file in bai.TaiNguyens)
                                                                        {
                                                                            var isDriveFile = file.Url.Contains("drive.google.com");
                                                                            var fileName = System.IO.Path.GetFileName(file.Url) ?? "File";

                                                                            <div class="col-md-6 col-lg-4">
                                                                                <div class="card h-100 shadow-sm border-0">
                                                                                    <div class="card-body p-3">
                                                                                        @if (file.Loai == "image")
                                                                                        {
                                                                                            var imageUrl = GetImageUrl(file.Url);
                                                                                            <img src="@imageUrl" alt="@fileName" class="card-img-top mb-3 rounded"
                                                                                                 style="height: 160px; object-fit: cover;" />
                                                                                            <a href="@file.Url" target="_blank" class="btn btn-outline-primary w-100">
                                                                                                <i class="fas fa-image me-2"></i>
                                                                                                Xem ảnh
                                                                                            </a>
                                                                                        }
                                                                                        else if (file.Loai == "video")
                                                                                        {
                                                                                            var previewUrl = GetVideoPreviewUrl(file.Url);

                                                                                            @if (isDriveFile)
                                                                                            {
                                                                                                <div class="ratio ratio-16x9 mb-3">
                                                                                                    <iframe src="@previewUrl" class="rounded border" allowfullscreen></iframe>
                                                                                                </div>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <video controls class="w-100 rounded mb-3" style="height: 160px;">
                                                                                                    <source src="@file.Url" type="video/mp4" />
                                                                                                    Trình duyệt không hỗ trợ video.
                                                                                                </video>
                                                                                            }

                                                                                            <a href="@file.Url" target="_blank" class="btn btn-outline-success w-100">
                                                                                                <i class="fas fa-play me-2"></i>
                                                                                                Xem video
                                                                                            </a>
                                                                                        }
                                                                                        else if (file.Loai == "tailieu")
                                                                                        {
                                                                                            <div class="text-center mb-3">
                                                                                                <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                                                                                <p class="fw-bold text-truncate">@fileName</p>
                                                                                            </div>
                                                                                            <a href="@file.Url" target="_blank" class="btn btn-outline-danger w-100">
                                                                                                <i class="fas fa-download me-2"></i>
                                                                                                Tải tài liệu
                                                                                            </a>
                                                                                        }
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="text-center text-muted py-4">
                                                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                                                    <p class="mb-0">Chương này chưa có bài học</p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-book fa-3x mb-3"></i>
                            <h5>Chưa có nội dung</h5>
                            <p>Bài giảng này chưa có chương nào được thêm vào.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Resources Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-archive me-2"></i>
                        Tài nguyên tổng hợp
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Images Column -->
                        <div class="col-lg-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-header bg-white border-bottom-0">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-images me-2"></i>
                                        Ảnh minh họa
                                        @if (taiNguyenAnh?.Any() == true)
                                        {
                                            <span class="badge bg-primary ms-2">@taiNguyenAnh.Count()</span>
                                        }
                                    </h5>
                                </div>
                                <div class="card-body">
                                    @if (taiNguyenAnh?.Any() == true)
                                    {
                                        <div class="row g-3">
                                            @foreach (var img in taiNguyenAnh.Take(4))
                                            {
                                                var finalUrl = GetImageUrl(img.Url);
                                                <div class="col-6">
                                                    <div class="card shadow-sm">
                                                        <img src="@finalUrl" alt="Ảnh minh họa"
                                                             class="card-img-top" style="height: 120px; object-fit: cover;" />
                                                        <div class="card-body p-2">
                                                            <a href="@img.Url" target="_blank" class="btn btn-sm btn-primary w-100">
                                                                <i class="fas fa-external-link-alt me-1"></i>
                                                                Xem
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        @if (taiNguyenAnh.Count() > 4)
                                        {
                                            <div class="text-center mt-3">
                                                <small class="text-muted">Và @(taiNguyenAnh.Count() - 4) ảnh khác...</small>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-image fa-2x mb-2 opacity-50"></i>
                                            <p class="mb-0">Chưa có ảnh minh họa</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Videos Column -->
                        <div class="col-lg-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-header bg-white border-bottom-0">
                                    <h5 class="mb-0 text-success">
                                        <i class="fas fa-video me-2"></i>
                                        Video minh họa
                                        @if (taiNguyenVideo?.Any() == true)
                                        {
                                            <span class="badge bg-success ms-2">@taiNguyenVideo.Count()</span>
                                        }
                                    </h5>
                                </div>
                                <div class="card-body">
                                    @if (taiNguyenVideo?.Any() == true)
                                    {
                                        @foreach (var video in taiNguyenVideo.Take(2))
                                        {
                                            var isDrive = video.Url.Contains("drive.google.com");
                                            var previewUrl = GetVideoPreviewUrl(video.Url);

                                            <div class="card shadow-sm mb-3">
                                                <div class="card-body p-2">
                                                    @if (isDrive)
                                                    {
                                                        <div class="ratio ratio-16x9 mb-2">
                                                            <iframe src="@previewUrl" class="rounded" allowfullscreen></iframe>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <video controls class="w-100 rounded mb-2" style="height: 120px;">
                                                            <source src="@video.Url" type="video/mp4" />
                                                            Trình duyệt không hỗ trợ video.
                                                        </video>
                                                    }
                                                    <a href="@video.Url" target="_blank" class="btn btn-sm btn-success w-100">
                                                        <i class="fas fa-play me-1"></i>
                                                        Xem video
                                                    </a>
                                                </div>
                                            </div>
                                        }
                                        @if (taiNguyenVideo.Count() > 2)
                                        {
                                            <div class="text-center">
                                                <small class="text-muted">Và @(taiNguyenVideo.Count() - 2) video khác...</small>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-video fa-2x mb-2 opacity-50"></i>
                                            <p class="mb-0">Chưa có video minh họa</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Documents Column -->
                        <div class="col-lg-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-header bg-white border-bottom-0">
                                    <h5 class="mb-0 text-danger">
                                        <i class="fas fa-file-alt me-2"></i>
                                        Tài liệu đính kèm
                                        @if (taiNguyenDocs?.Any() == true)
                                        {
                                            <span class="badge bg-danger ms-2">@taiNguyenDocs.Count()</span>
                                        }
                                    </h5>
                                </div>
                                <div class="card-body">
                                    @if (taiNguyenDocs?.Any() == true)
                                    {
                                        @foreach (var doc in taiNguyenDocs.Take(3))
                                        {
                                            <div class="card shadow-sm mb-3">
                                                <div class="card-body text-center p-3">
                                                    <i class="fas fa-file-pdf text-danger mb-2" style="font-size: 2.5rem;"></i>
                                                    <p class="mb-2 fw-medium small">Tài liệu đính kèm</p>
                                                    <a href="@doc.Url" target="_blank" class="btn btn-danger btn-sm w-100">
                                                        <i class="fas fa-download me-1"></i>
                                                        Tải về
                                                    </a>
                                                </div>
                                            </div>
                                        }
                                        @if (taiNguyenDocs.Count() > 3)
                                        {
                                            <div class="text-center">
                                                <small class="text-muted">Và @(taiNguyenDocs.Count() - 3) tài liệu khác...</small>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-file-alt fa-2x mb-2 opacity-50"></i>
                                            <p class="mb-0">Chưa có tài liệu đính kèm</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    string GetImageUrl(string url)
    {
        if (url.Contains("drive.google.com") && url.Contains("/file/d/"))
        {
            var match = System.Text.RegularExpressions.Regex.Match(url, @"/file/d/([a-zA-Z0-9_-]+)");
            if (match.Success)
            {
                var id = match.Groups[1].Value;
                return $"https://drive.google.com/thumbnail?id={id}";
            }
        }
        return url;
    }

    string GetVideoPreviewUrl(string url)
    {
        if (url.Contains("drive.google.com") && url.Contains("/view"))
        {
            return System.Text.RegularExpressions.Regex.Replace(url, "/view.*$", "/preview");
        }
        return url;
    }

    string GetDocumentPreviewUrl(string url)
    {
        if (url.Contains("drive.google.com") && url.Contains("/view"))
        {
            return System.Text.RegularExpressions.Regex.Replace(url, "/view.*$", "/preview");
        }
        return url;
    }
}